# Технические детали и скрипты 

## Конфигурационные файлы

### Настройка Fail2Ban

Файл `/etc/fail2ban/jail.local` (изменения):
```ini
[sshd]
enabled = true
port    = ssh
logpath = %(sshd_log)s
backend = %(sshd_backend)s
```

### Скрипт симуляции атаки

Файл `simulate_attack.sh`:
```bash
#!/bin/bash
# Симуляция атаки на SSH для тестирования Fail2Ban

echo "Симуляция атаки на SSH..."

# Попытки подключения с неверными учетными данными
for i in {1..15}; do
    echo "Попытка $i..."
    timeout 3 ssh -o ConnectTimeout=2 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
        -o PasswordAuthentication=yes \
        -l attacker 10.128.0.8 "exit" 2>/dev/null || true
    sleep 1
done

echo "Атака завершена"
```

## Команды для анализа

### Проверка статуса сервисов
```bash
# Статус Suricata
sudo systemctl status suricata

# Статус Fail2Ban
sudo systemctl status fail2ban

# Статус jail в Fail2Ban
sudo fail2ban-client status sshd
```

### Анализ логов
```bash
# Логи Fail2Ban
sudo tail -f /var/log/fail2ban.log

# Логи Suricata
sudo tail -f /var/log/suricata/fast.log

# Логи SSH
sudo tail -f /var/log/auth.log | grep -i failed
```

### Управление Fail2Ban
```bash
# Заблокировать IP
sudo fail2ban-client set sshd banip <IP>

# Разблокировать IP
sudo fail2ban-client set sshd unbanip <IP>

# Перезапуск Fail2Ban
sudo systemctl restart fail2ban
```

## Результаты тестирования

### Временные характеристики nmap сканирования

| Команда | Время выполнения | Обнаруженные порты | Детали |
|---------|------------------|-------------------|---------|
| `nmap -sA` | 0.08 сек | Все unfiltered | ACK сканирование |
| `nmap -sT` | 0.04 сек | SSH (22) | TCP connect |
| `nmap -sS` | 0.13 сек | SSH (22) | SYN сканирование |
| `nmap -sV` | 0.56 сек | SSH + версия | Детекция версий |

### Статистика Fail2Ban

**До атаки:**
- Всего обнаружено попыток: 4 (внешние IP)
- Заблокированных IP: 0

**После атаки:**
- Всего обнаружено попыток: 9
- Заблокированных IP: 1 (10.128.0.8)
- Время блокировки: 10 минут
- Лимит попыток: 5 за 10 минут

## Рекомендации по улучшению

### 1. Настройка Suricata

```bash
# Обновление правил
sudo suricata-update

# Настройка правил для портового сканирования
sudo nano /etc/suricata/rules/local.rules
```

Добавить правила:
```
# Обнаружение nmap сканирования
alert tcp any any -> any any (msg:"NMAP TCP ACK Scan"; flags:A; ack:1; dsize:0; threshold: type both, track by_src, count 100, seconds 60; sid:1000001; rev:1;)

# Обнаружение SSH брутфорс
alert tcp any any -> any 22 (msg:"SSH Brute Force Attempt"; content:"SSH-"; threshold: type both, track by_src, count 5, seconds 60; sid:1000002; rev:1;)
```

### 2. Улучшение Fail2Ban

```ini
[DEFAULT]
bantime = 3600
findtime = 300
maxretry = 3

[sshd]
enabled = true
maxretry = 3
bantime = 3600
findtime = 300
```

### 3. Настройка SSH

```bash
# Отключение аутентификации по паролю
sudo sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

# Включение только ключевой аутентификации
echo "AuthenticationMethods publickey" | sudo tee -a /etc/ssh/sshd_config

# Перезапуск SSH
sudo systemctl restart ssh
```

## Мониторинг и алерты

### Скрипт мониторинга

```bash
#!/bin/bash
# Скрипт для мониторинга событий безопасности

LOG_FILE="/var/log/security_monitor.log"
DATE=$(date '+%Y-%m-%d %H:%M:%S')

# Проверка заблокированных IP
BANNED_IPS=$(sudo fail2ban-client status sshd | grep "Banned IP list" | cut -d: -f2)

if [ ! -z "$BANNED_IPS" ]; then
    echo "[$DATE] Заблокированные IP: $BANNED_IPS" >> $LOG_FILE
fi

# Проверка новых атак
NEW_ATTACKS=$(sudo tail -10 /var/log/fail2ban.log | grep "Ban" | tail -1)
if [ ! -z "$NEW_ATTACKS" ]; then
    echo "[$DATE] Новая атака: $NEW_ATTACKS" >> $LOG_FILE
fi
```

### Настройка cron для мониторинга

```bash
# Добавить в crontab
*/5 * * * * /path/to/security_monitor.sh
```

## Заключение

Данная лабораторная работа продемонстрировала:

1. **Эффективность Fail2Ban** в защите от брутфорс атак
2. **Необходимость настройки Suricata** для полной функциональности
3. **Важность многоуровневой защиты** сети
4. **Необходимость регулярного мониторинга** событий безопасности

Полученные знания и навыки позволяют:
- Настраивать и администрировать системы IDS/IPS
- Анализировать логи безопасности
- Выявлять и предотвращать сетевые атаки
- Обеспечивать комплексную защиту информационных систем

---
**Студент:** Зарубов Николай  
**Дата:** 12 октября 2025 г.
